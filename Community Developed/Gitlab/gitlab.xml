<?xml version="1.0" encoding="UTF-8" ?>
<Workflow name="Gitlab Audit Events" version="1.0" xmlns="http://qradar.ibm.com/UniversalCloudRESTAPI/Workflow/V2">

    <Parameters>

        <Parameter name="api_host" label="API Host" required="true" />
        <Parameter name="access_token" label="Gitlab Personal Access Token" required="true" secret="true" />

	<Parameter name="log_type" label="Audit log type: `groups`, `projects` or `instance`" required="true" />
        <Parameter name="object_id" label="Group or project ID" required="false" />

    </Parameters>

    <Actions>

        <If condition="'${/log_type}' = 'instance'">
            <Initialize path="/url" value="https://${/api_host}/api/v4/audit_events" />
        </If>
        <ElseIf condition="'${/log_type}' = 'projects' or '${/log_type}' = 'groups'">
            <Initialize path="/url" value="https://${/api_host}/api/v4/${/log_type}/${/object_id}/audit_events" />
        </ElseIf>
	<Log type="INFO" message="Initialized URL ${/url}." />

	<Initialize path="/events/body" value="[]" />
	<Initialize path="/next_page" value="1" />

        <FormatDate pattern="YYYY-MM-dd'T'HH:mm:ss" timeZone="UTC" time="${time() - 60 * 1000}" savePath="/since_timestamp" />

        <DoWhile condition="count(/events/body) > 0">

            <Log type="INFO" message="Processing events for page ${/next_page - 1}." />

	    <ForEach item="/event" items="/events/body">
                <PostEvent path="/event" source="${/api_host}"/>
            </ForEach>

            <CallEndpoint url="${/url}" method="GET" savePath="/events">
                <QueryParameter name="private_token" value="${/access_token}" />
                <QueryParameter name="per_page" value="20" />
                <QueryParameter name="page" value="${/next_page}" />
                <QueryParameter name="created_after" value="${/since_timestamp}" />
            </CallEndpoint>

            <If condition="/respose/status_code != 200">
                <Log type="ERROR" message="Problem fetching logs, response was: ${/response}." />
            </If>

            <Set path="/next_page" value="${/next_page + 1}" />
            
        </DoWhile>
       
    </Actions>

    <Tests>
        <DNSResolutionTest host="${/api_host}" />
        <TCPConnectionTest host="${/api_host}" />
        <SSLHandshakeTest host="${/api_host}" />
        <HTTPConnectionThroughProxyTest url="https://${/api_host}" />
    </Tests>

</Workflow>

